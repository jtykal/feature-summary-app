<!DOCTYPE html>
<html>
<head>
    <title>featuredefectsummary</title>

    <script type="text/javascript" src="/apps/2.0rc2/sdk.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/async/0.2.7/async.min.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var app=null;Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",items:{},config:{defaultSettings:{showTime:!1,showTasks:!0}},getSettingsFields:function(){return[{name:"showTime",xtype:"rallycheckboxfield",label:"Selected to show Time Tracker column"},{name:"showTasks",xtype:"rallycheckboxfield",label:"Selected to show Task columns"}]},launch:function(){app=this,app.showTime=app.getSetting("showTime"),app.showTasks=app.getSetting("showTasks"),console.log("Hello World!"),this.addFeatureGrid()},timeColumn:{text:"Time",width:100,renderer:function(value,metaData,record,rowIdx,colIdx,store,view){var defects=record.get("Defects");if(defects&&defects.length>0){var states=_.countBy(defects,function(d){return"Closed"!=d.get("State")?"Open":"Closed"});states.Open=void 0!==states.Open?states.Open:0,states.length=defects.length;var tpl=Ext.create("Ext.Template","{Open}/{length}",{compiled:!0});return tpl.apply(states)}return""}},taskEstimateColumn:{text:"Task Estimate",width:100,renderer:function(value,metaData,record,rowIdx,colIdx,store,view){var tasks=record.get("Tasks"),estimate=_.reduce(tasks,function(sum,task){return sum+(_.isNumber(task.get("Estimate"))?task.get("Estimate"):0)},0);return estimate>0?estimate:""}},taskToDoColumn:{text:"Task ToDo",width:100,renderer:function(value,metaData,record,rowIdx,colIdx,store,view){var tasks=record.get("Tasks"),todo=_.reduce(tasks,function(sum,task){return sum+(_.isNumber(task.get("ToDo"))?task.get("ToDo"):0)},0);return todo>0?todo:""}},taskActualsColumn:{text:"Task Actuals",width:100,renderer:function(value,metaData,record,rowIdx,colIdx,store,view){var tasks=record.get("Tasks"),actuals=_.reduce(tasks,function(sum,task){return sum+(_.isNumber(task.get("Actuals"))?task.get("Actuals"):0)},0);return actuals>0?actuals:""}},defectColumn:{text:"Defects",width:100,renderer:function(value,metaData,record,rowIdx,colIdx,store,view){var defects=record.get("Defects");if(defects&&defects.length>0){var states=_.countBy(defects,function(d){return"Closed"!=d.get("State")?"Open":"Closed"});states.Open=void 0!==states.Open?states.Open:0,states.length=defects.length;var tpl=Ext.create("Ext.Template","{Open}/{length}",{compiled:!0});return tpl.apply(states)}return""}},blockedColumn:{text:"Blocked",width:100,renderer:function(value,metaData,record,rowIdx,colIdx,store,view){var blockedSnapshots=record.get("Blocked");return!_.isUndefined(blockedSnapshots)&&blockedSnapshots.length>0?blockedSnapshots.length:""}},addFeatureGrid:function(){Rally.data.ModelFactory.getModel({type:"PortfolioItem/Feature",success:function(userStoryModel){var columnCfgs=["FormattedID","Name","Owner",app.defectColumn,app.blockedColumn];app.showTime&&columnCfgs.push(app.timeColumn),app.showTasks&&(columnCfgs.push(app.taskEstimateColumn),columnCfgs.push(app.taskToDoColumn),columnCfgs.push(app.taskActualsColumn));var grid=Ext.create("Rally.ui.grid.Grid",{xtype:"rallygrid",model:userStoryModel,listeners:{load:function(items){console.log("load",items.data.items);var features=items.data.items;async.map(features,app.getSnapshots,function(err,results){_.each(features,function(feature,i){feature.set("Defects",results[i])}),async.map(features,app.getBlockedSnapshots,function(err,results){_.each(features,function(feature,i){feature.set("Blocked",results[i])}),async.map(features,app.getTaskSnapshots,function(err,results){_.each(features,function(feature,i){results[i].length>0&&console.log(results[i]),feature.set("Tasks",results[i])})})})})}},columnCfgs:columnCfgs});console.log(app.showTime),app.showTime&&grid.columnCfgs.push(app.timeColumn),app.add(grid)}})},getSnapshots:function(record,callback){var that=this,fetch=["ObjectID","_UnformattedID","State","Priority","Severity","_ItemHierarchy","_TypeHierarchy"],hydrate=["_TypeHierarchy","State","Priority","Severity"],find={_TypeHierarchy:{$in:["Defect"]},_ProjectHierarchy:{$in:[app.getContext().getProject().ObjectID]},__At:"current",_ItemHierarchy:{$in:[record.get("ObjectID")]}},storeConfig={find:find,autoLoad:!0,pageSize:1e3,limit:"Infinity",fetch:fetch,hydrate:hydrate,listeners:{scope:this,load:function(store,snapshots,success){callback(null,snapshots)}}},snapshotStore=Ext.create("Rally.data.lookback.SnapshotStore",storeConfig)},getBlockedSnapshots:function(record,callback){var that=this,fetch=["_TypeHierarchy","FormattedID","ObjectID","_UnformattedID","Name","Owner","Blocked","ScheduleState"],hydrate=["_TypeHierarchy","ScheduleState"],find={_TypeHierarchy:{$in:["Defect","HierarchicalRequirement"]},__At:"current",_ItemHierarchy:{$in:[record.get("ObjectID")]},Blocked:!0},storeConfig={find:find,autoLoad:!0,pageSize:1e3,limit:"Infinity",fetch:fetch,hydrate:hydrate,listeners:{scope:this,load:function(store,snapshots,success){callback(null,snapshots)}}},snapshotStore=Ext.create("Rally.data.lookback.SnapshotStore",storeConfig)},getTaskSnapshots:function(record,callback){var that=this,fetch=["ObjectID","Estimate","ToDo","Actuals","_ItemHierarchy","_TypeHierarchy"],hydrate=["_TypeHierarchy"],find={_TypeHierarchy:{$in:["Task"]},_ProjectHierarchy:{$in:[app.getContext().getProject().ObjectID]},__At:"current",_ItemHierarchy:{$in:[record.get("ObjectID")]}},storeConfig={find:find,autoLoad:!0,pageSize:1e3,limit:"Infinity",fetch:fetch,hydrate:hydrate,listeners:{scope:this,load:function(store,snapshots,success){callback(null,snapshots)}}},snapshotStore=Ext.create("Rally.data.lookback.SnapshotStore",storeConfig)},getAllFeatureSnapshots:function(record,callback){var that=this,fetch=["ObjectID","_TypeHierarchy"],hydrate=["_TypeHierarchy"],find={_TypeHierarchy:{$in:["Defect","Task","HierarchicalRequirement"]},_ProjectHierarchy:{$in:[app.getContext().getProject().ObjectID]},__At:"current",_ItemHierarchy:{$in:[record.get("ObjectID")]}},storeConfig={find:find,autoLoad:!0,pageSize:1e3,limit:"Infinity",fetch:fetch,hydrate:hydrate,listeners:{scope:this,load:function(store,snapshots,success){callback(null,snapshots)}}},snapshotStore=Ext.create("Rally.data.lookback.SnapshotStore",storeConfig)},timeEntryItems:function(refs,callback){var configs=[{model:"TypeDefinition",fetch:!0,filters:app.createTimeEntryFilter(refs)}];async.map(configs,app.wsapiQuery,function(err,results){callback(null,results)})},createTimeEntryFilter:function(refs){var filter=null;return _.each(refs,function(ref,i){var filterFieldName=-1===ref.toLowerCase().indexOf("task")?"WorkProduct":"Task",f=Ext.create("Rally.data.wsapi.Filter",{property:filterFieldName,operator:"=",value:ref});filter=0===i?f:filter.or(f)}),console.log("Time Filter:",""+filter),filter},wsapiQuery:function(config,callback){Ext.create("Rally.data.WsapiDataStore",{autoLoad:!0,limit:"Infinity",model:config.model,fetch:config.fetch,filters:config.filters,listeners:{scope:this,load:function(store,data){callback(null,data)}}})}});

            Rally.launchApp('CustomApp', {
                name:"featuredefectsummary",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
